



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Implementation considerations - Order Microservice CQRS and Event Sourcing</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#code-structure" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Order Microservice CQRS and Event Sourcing" class="md-header-nav__button md-logo">
          
            <img src="../images/cloud.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Order Microservice CQRS and Event Sourcing
            </span>
            <span class="md-header-nav__topic">
              Implementation considerations
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Order Microservice CQRS and Event Sourcing" class="md-nav__button md-logo">
      
        <img src="../images/cloud.png" width="48" height="48">
      
    </a>
    Order Microservice CQRS and Event Sourcing
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      From event storming to CQRS microservice
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        From event storming to CQRS microservice
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ddd-applied/" title="Order subdomain - analysis and design" class="md-nav__link">
      Order subdomain - analysis and design
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Implementation considerations
      </label>
    
    <a href="./" title="Implementation considerations" class="md-nav__link md-nav__link--active">
      Implementation considerations
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#code-structure" title="Code structure" class="md-nav__link">
    Code structure
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app-layer" title="App layer" class="md-nav__link">
    App layer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-layer" title="Domain layer" class="md-nav__link">
    Domain layer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-model" title="Data Model" class="md-nav__link">
    Data Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main-classes-of-the-command-service" title="Main classes of the command service" class="md-nav__link">
    Main classes of the command service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#infrastructure-layer" title="Infrastructure Layer" class="md-nav__link">
    Infrastructure Layer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#command-events" title="Command Events" class="md-nav__link">
    Command Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#factual-events" title="Factual Events" class="md-nav__link">
    Factual Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../build-run/" title="Build and run locally" class="md-nav__link">
      Build and run locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deployments/" title="Deploy to Kubernetes cluster" class="md-nav__link">
      Deploy to Kubernetes cluster
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/event-sourcing" title="Event sourcing pattern" class="md-nav__link">
      Event sourcing pattern
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/cqrs" title="CQRS pattern" class="md-nav__link">
      CQRS pattern
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc/itg-tests/" title="Integration tests" class="md-nav__link">
      Integration tests
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#code-structure" title="Code structure" class="md-nav__link">
    Code structure
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#app-layer" title="App layer" class="md-nav__link">
    App layer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domain-layer" title="Domain layer" class="md-nav__link">
    Domain layer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-model" title="Data Model" class="md-nav__link">
    Data Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main-classes-of-the-command-service" title="Main classes of the command service" class="md-nav__link">
    Main classes of the command service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#infrastructure-layer" title="Infrastructure Layer" class="md-nav__link">
    Infrastructure Layer
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#command-events" title="Command Events" class="md-nav__link">
    Command Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#factual-events" title="Factual Events" class="md-nav__link">
    Factual Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/edit/master/docs/implementation-considerations.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Implementation considerations</h1>
                
                <p>As introduced in the <a href="ddd-applied">solution design note</a> the order entity life cycle looks like in the following diagram:</p>
<p><img alt="" src="../images/order-life-cycle-2.png" /></p>
<p>The order microservice supports the implementations of this life cycle, using event sourcing and CQRS pattern.</p>
<p>With <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/cqrs/">CQRS</a>, we separate the 'write model' from the 'read model'. The Command microservice implements the 'write model' and exposes a set of REST end points for Creating Order, Updating, Deleting Order and getting Order per ID. The query service will address more complex queries to support adhoc business requirements and most likely will need to join data between different entities like the order, the containers and the voyages. So we have two Java projects to support each service implementation. Each service is packaged as container and deployable to Kubernetes. </p>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/tree/master/order-command-ms">Order command microservice</a></li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/tree/master/order-query-ms">Order query microservice</a></li>
</ul>
<p>As some requirements are related to historical query, using an event approach, we need to keep all the events related to what happens to the order. Instead of implementing a complex logic with the query and command services, the event sourcing is supported by using Kafka topics. The following diagram illustrates the CQRS and event sourcing applied to the order management service. Client to the REST api, like a back end for front end app, performs a HTTP POST operation with the order data. The command generates events and persists order on its own data source. The query part is an event consumer and defines its own data projections to support the different queries:</p>
<p><img alt="" src="../images/order-ms-cqrs-es.png" /> </p>
<p>The datasource at the command level, may not be necessary, but we want to illustrate here the fact that it is possible to have a SQL based database or a document oriented database to keep the order last state: a call to get /orders/{id} will return the current order state. </p>
<p>For the query part, the projection can be kept in memory or persisted on its own data store. The decision, to go for in memory or to use a database, depends upon the amount of data to join, and the persitence time horizon set at the Kafka topic level. In case of problem or while starting, an event driven service may always rebuild its view by re-reading the topic from the beginning. </p>
<p>As the BFF still needs to get order by ID or perform complex queries, it has to access the order service using HTTP, therefore we have prefered to use one communication protocol.  </p>
<p>The following sequence diagram illustrates the relationships between the components over time for the new shipping order processing:</p>
<p><img alt="" src="../images/order-cmd-query-flow.png" /></p>
<p>To avoid transaction between the database update and the event published, the choice is to publish the command event to a specific kafka topic (<code>orderCommands</code>) as early as the shipping order data is received and use a consumer inside the command service to load the data and save to the database. The kafka topic act as a source of trust for this service. This is illustrated in <a href="https://ibm-cloud-architecture.github.io/refarch-eda/design-patterns/cqrs/#the-consistency-challenge">this article.</a></p>
<p>The following diagram illustrates the update shipping oder flow, and the call to a complex query from a remote client going directly to the query microservice:</p>
<p><img alt="" src="../images/update-order.png" /></p>
<h2 id="code-structure">Code structure</h2>
<p>For the order command microservice we implemented a domain driven design structure and try to use the ubiquituous language in the code. The first difficult practice it to well organize the code: The layering approach is used:</p>
<p><img alt="" src="../images/code-structure.png" /></p>
<ul>
<li><strong>Core</strong> is the building blocks not specific to any domain or technology, containing generic building blocks like Lists, Maps, Case Classes, Actors and Lenses. </li>
<li><strong>Infrastructure</strong> contains adapters for various technologies such as databases, user interface and external services. </li>
<li><strong>Domain</strong> is where all business logic resides with classes and methods named using the ubiquitous language for the domain. The business logic and rules go there. It has access to infrastructure and core.</li>
<li><strong>The App</strong> layer, acts as the entry point to the domain, using Domain terms and objects from the Domain. App includes APIs.
 API should only expose immutable objects to prevent developers from using the exposed objects to gain access to the underlying domain, thus manipulating the domain.</li>
</ul>
<p>A given level can see only the components of its layer or lower</p>
<h3 id="app-layer">App layer</h3>
<p>As defined by the list of commands to implements, most those operations are defined in an API. The unique REST resource is the class: <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/app/ShippingOrderResource.java">ShippingOrderResource</a></p>
<p>When the application starts there is a <a href="https://docs.oracle.com/javaee/6/api/javax/servlet/ServletContextListener.html">ServletContextListener</a> implementation class started to create kafka consumers. When consumers reach an issue to get events, they create an error to the <code>errors</code> topic, so administrator user could replay the events from the last committed offset. Any kafka broker communication issue is shutting down the consumer loop.</p>
<h3 id="domain-layer">Domain layer</h3>
<p>The domain layer implements the business logic, defines the main business entities and value objects, and defines services used by app layer.</p>
<h4 id="data-model">Data Model</h4>
<p>We have identified aggregates, entities, value objects and business policies and rules. Those elements help us to build our information model as classes. For any event-driven microservice you need to assess what data to carry in the event and what to persist in the potential data source. </p>
<p>The following diagram illustrates the different data models in the context of this order microservice:</p>
<p><img alt="" src="../order-evt-data.png" /></p>
<p>The Order entered in the User interface is defined like:
<div class="codehilite"><pre><span></span> <span class="nt">class</span> <span class="nt">Address</span> <span class="p">{</span>
    <span class="n">street</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">city</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">country</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">zipcode</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>

 <span class="nt">class</span> <span class="nt">ShippinOrder</span> <span class="p">{</span>
    <span class="n">orderID</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">customerID</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">pickupAddress</span><span class="p">:</span> <span class="n">Address</span><span class="p">;</span>
    <span class="n">destinationAddress</span><span class="p">:</span> <span class="n">Address</span><span class="p">;</span>
    <span class="n">productID</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>
    <span class="n">expectedDeliveryDate</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span>   <span class="err">//</span>  <span class="err">date</span> <span class="err">as</span> <span class="err">ISO</span> <span class="err">format</span>
<span class="p">}</span>
</pre></div></p>
<p>The information to persist in the database may be used to do analytics, and get the last status of order. It may use relational database and may have information like Address table, ShippingOrder table and ReeferOrder join table.</p>
<h4 id="main-classes-of-the-command-service">Main classes of the command service</h4>
<p><img alt="" src="../images/order-cmd-classes.png" /></p>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/app/ShippingOrderResource.java">ShippingOrderResource</a> is the REST api resource class for <code>/orders</code> POST, PUT and GET. It is part of the app layer.</li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/domain/service/ShippingOrderService.java">ShippingOrderService</a> is part of the domain layer, and groups the service operation to manage a shipping order. </li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/repository/ShippingOrderRepository.java">ShippingOrderRepository</a> This is an interface, but there is a mockup implementation to keep the data in memory. It is part of the infrastructure layer.</li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderCommandProducer.java">OrderCommandProducer</a> is part of the infrastructure, and produce command event to sequence the operation between the messaging and the database.</li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderCommandAgent.java">OrderCommandAgent</a> is also part of the infrastructure, with its counter part class the <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/OrderCommandRunner.java">OrderCommandRunner</a> which loop on polling message from the <code>orderCommands</code> topic.</li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderEventProducer.java">OrderEventProducer</a> is producing events for other microservice to consume.</li>
</ul>
<p>The following sequence diagram illustrates how those components are working together:</p>
<p><img alt="" src="../images/seq-diagram.png" /></p>
<h3 id="infrastructure-layer">Infrastructure Layer</h3>
<p>This layer includes Repository and Agents consumer of events as well as event emitters for the command events and the factual events. Normally events are factuals per design. This is just a  little bit of semantic play here, as we are using command events to manage data integrity.</p>
<h4 id="command-events">Command Events</h4>
<p>We did use command event to avoid XA transaction between kafka and database. So we use a 'private' topic: <code>orderCommands</code> to queue the commands to create or update a Shipping order. The command microservice has an agent to consume such events, get the shipping order data and save to the database.</p>
<p>See this class: <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms/blob/master/order-command-ms/src/main/java/ibm/gse/orderms/infrastructure/kafka/OrderCommandAgent.java">OrderCommandAgent</a></p>
<h4 id="factual-events">Factual Events</h4>
<p>On the event side, we may generate OrderCreated, OrderCancelled,... so other services can act on those shipping order changes. The event payload will depend of the event type. So we first define a base class for timestamp, version and type. Then each specific event define the payload.</p>
<p><img alt="" src="../images/event-model.png" /></p>
<p>We can propose the following structure where type will help to specify the event type and by getting a generic payload we can have anything in it.</p>
<div class="codehilite"><pre><span></span><span class="kr">class</span> <span class="nx">OrderEventBase</span> <span class="p">{</span>
    <span class="nx">timestamp</span>: <span class="kt">string</span><span class="p">;</span>   <span class="c1">//  date as ISO format</span>
    <span class="nx">payload</span>: <span class="kt">any</span><span class="p">;</span>
    <span class="nx">type</span>: <span class="kt">string</span><span class="p">;</span>
    <span class="nx">version</span>: <span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p><code>version</code> attribute will be used when we will use a schema registry. Using Avro and schema registry will help managing different version of the payload. </p>
<div class="codehilite"><pre><span></span><span class="kr">class</span> <span class="nx">ReeferAssignedEvent</span> <span class="kr">extends</span> <span class="nx">OrderEventBase</span> <span class="p">{</span>
    <span class="nx">ReeferAssignmentPayload</span> <span class="nx">payload</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>In traditional SOA service with application maintaining all the tables and beans to support all the business requirements, ACID transactions support the consistency and integrity of the data, and the database is one source of truth. With event driven microservices responsible to manage its own aggregate, clearly separated from other business entities, data eventual consistency is the standard, and adopting event sourcing pattern and an event backbone, like kafka, which becomes the source of truth. </p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../ddd-applied/" title="Order subdomain - analysis and design" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Order subdomain - analysis and design
              </span>
            </div>
          </a>
        
        
          <a href="../build-run/" title="Build and run locally" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Build and run locally
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>